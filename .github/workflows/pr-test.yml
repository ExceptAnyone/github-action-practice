name: PR Test

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/pnpm-setup-node

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        id: typecheck
        run: |
          echo "## ğŸ” Type Check" >> test_results.md
          if pnpm run type-check; then
            echo "âœ… Type check passed" >> test_results.md
            echo "typecheck_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "typecheck_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Type check failed" >> test_results.md
            echo "typecheck_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "typecheck_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run lint
        id: lint
        if: steps.typecheck.outputs.typecheck_result == 'success'
        run: |
          echo "" >> test_results.md
          echo "## ğŸ“ Lint Check" >> test_results.md
          if pnpm run lint; then
            echo "âœ… Lint check passed" >> test_results.md
            echo "lint_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "lint_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Lint check failed" >> test_results.md
            echo "lint_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "lint_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run test
        id: test
        if: steps.lint.outputs.lint_result == 'success'
        run: |
          echo "" >> test_results.md
          echo "## ğŸ§ª Tests" >> test_results.md
          if pnpm run test; then
            echo "âœ… Tests passed" >> test_results.md
            echo "test_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "test_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed" >> test_results.md
            echo "test_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "test_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get current time
        uses: josStorer/get-current-time@v2
        id: current-time
        if: always()
        with:
          format: 'YYYYë…„ MMì›” DDì¼ HHì‹œ mmë¶„ ssì´ˆ'
          utcOffset: '+09:00'

      - name: Set skipped statuses
        if: always()
        run: |
          if [[ "${{ steps.typecheck.outputs.typecheck_result }}" != "success" ]]; then
            echo "lint_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
            echo "test_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.lint.outputs.lint_result }}" != "success" ]]; then
            echo "test_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
          fi
        id: skipped

      - name: Comment PR with test results
        uses: thollander/actions-comment-pull-request@v2
        if: always()
        with:
          comment_tag: ${{ github.event.number }}-test-results
          message: |
            ## ğŸš€ í…ŒìŠ¤íŠ¸ ê²°ê³¼

            **ì‹¤í–‰ ì‹œê°„**: ${{ steps.current-time.outputs.formattedTime }}
            **ì»¤ë°‹**: ${{ github.event.pull_request.head.sha }}

            ### ğŸ“Š ìš”ì•½
            - **Type Check**: ${{ steps.typecheck.outputs.typecheck_status || 'â­ï¸ ê±´ë„ˆëœ€' }}
            - **Lint**: ${{ steps.lint.outputs.lint_status || steps.skipped.outputs.lint_status || 'â­ï¸ ê±´ë„ˆëœ€' }}
            - **Tests**: ${{ steps.test.outputs.test_status || steps.skipped.outputs.test_status || 'â­ï¸ ê±´ë„ˆëœ€' }}

            ---
