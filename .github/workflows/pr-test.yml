name: PR Test

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/pnpm-setup-node

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        id: typecheck
        run: |
          echo "## ğŸ” Type Check" >> test_results.md
          if pnpm run type-check; then
            echo "âœ… Type check passed" >> test_results.md
            echo "typecheck_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "âŒ Type check failed" >> test_results.md
            echo "typecheck_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run lint
        id: lint
        run: |
          echo "" >> test_results.md
          echo "## ğŸ“ Lint Check" >> test_results.md
          if pnpm run lint; then
            echo "âœ… Lint check passed" >> test_results.md
            echo "lint_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "âŒ Lint check failed" >> test_results.md
            echo "lint_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run test
        id: test
        run: |
          echo "" >> test_results.md
          echo "## ğŸ§ª Tests" >> test_results.md
          if pnpm run test; then
            echo "âœ… Tests passed" >> test_results.md
            echo "test_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed" >> test_results.md
            echo "test_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Get current time
        uses: josStorer/get-current-time@v2
        id: current-time
        with:
          format: 'YYYYë…„ MMì›” DDì¼ HHì‹œ mmë¶„ ssì´ˆ'
          utcOffset: '+09:00'

      - name: Comment PR with test results
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: ${{ github.event.number }}-test-results
          message: |
            ## ğŸš€ í…ŒìŠ¤íŠ¸ ê²°ê³¼

            **ì‹¤í–‰ ì‹œê°„**: ${{ steps.current-time.outputs.formattedTime }}
            **ì»¤ë°‹**: ${{ github.event.pull_request.head.sha }}

            ### ğŸ“Š ìš”ì•½
            - **Type Check**: ${{ steps.typecheck.outputs.typecheck_status }}
            - **Lint**: ${{ steps.lint.outputs.lint_status }}
            - **Tests**: ${{ steps.test.outputs.test_status }}

            ---

            $(cat test_results.md)
